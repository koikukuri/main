/**
 * LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å–å¾—ã—ãŸã€ã‚ãªãŸã®ãƒãƒ£ãƒãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
 * ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¨­å®šã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚
 */
const CHANNEL_ACCESS_TOKEN = PropertiesService.getScriptProperties().getProperty('CHANNEL_ACCESS_TOKEN');

/**
 * å‚åŠ è€…ã®æƒ…å ±ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚·ãƒ¼ãƒˆå
 */
const USER_SHEET_NAME = 'å‚åŠ ä¸­';

/**
 * ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹ã‚·ãƒ¼ãƒˆå
 */
const LOG_SHEET_NAME = 'ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°';

/**
 * ãƒ­ã‚°ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€é–¢æ•°
 * @param {string} message - è¨˜éŒ²ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 */
function logToSheet(message) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let logSheet = spreadsheet.getSheetByName(LOG_SHEET_NAME);
    
    if (!logSheet) {
      logSheet = spreadsheet.insertSheet(LOG_SHEET_NAME);
      logSheet.appendRow(['ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—', 'ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸']);
    }
    
    const timestamp = new Date();
    logSheet.appendRow([timestamp, message]);
  } catch (e) {
    console.error("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ãƒ­ã‚°æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
  }
}

/**
 * LIFFã‚¢ãƒ—ãƒªã‹ã‚‰POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã£ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
 */
function doPost(e) {
  logToSheet("doPosté–¢æ•°ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚");
  try {
    const data = JSON.parse(e.postData.contents);
    // â˜…â˜…â˜… LIFFã‚¢ãƒ—ãƒªã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹ã®ã¯ 'userId' ã§ã™ â˜…â˜…â˜…
    const userId = data.userId; 

    if (!userId) {
      logToSheet("ã‚¨ãƒ©ãƒ¼: LIFFã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒé€ã‚‰ã‚Œã¦ãã¾ã›ã‚“ã§ã—ãŸã€‚");
      throw new Error("ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    }
    logToSheet(`ã‚¯ãƒªã‚¢ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ID: ã€Œ${userId}ã€`);

    // --- â˜…â˜…â˜… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰åå‰ã‚’æ¤œç´¢ã™ã‚‹æ©Ÿèƒ½ â˜…â˜…â˜… ---
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(USER_SHEET_NAME);
    if (!sheet) {
      logToSheet(`ã‚¨ãƒ©ãƒ¼: ã‚·ãƒ¼ãƒˆã€Œ${USER_SHEET_NAME}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
      throw new Error(`ã‚·ãƒ¼ãƒˆã€Œ${USER_SHEET_NAME}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
    }
    logToSheet(`ã‚·ãƒ¼ãƒˆã€Œ${USER_SHEET_NAME}ã€ã‚’æ­£å¸¸ã«å–å¾—ã—ã¾ã—ãŸã€‚`);

    const allData = sheet.getDataRange().getValues();
    let userName = null;
    // Båˆ—(ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1)ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æ¤œç´¢ã—ã€ä¸€è‡´ã—ãŸè¡Œã®Dåˆ—(ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹3)ã®åå‰ã‚’å–å¾—ã—ã¾ã™
    for (let i = 1; i < allData.length; i++) { // 1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ãªã®ã§i=1ã‹ã‚‰
      if (allData[i][1] === userId) { // Båˆ—ã®IDãŒä¸€è‡´ã—ãŸã‚‰
        userName = allData[i][3]; // Dåˆ—ã®åå‰ã‚’å–å¾—
        break;
      }
    }

    if (!userName) {
        logToSheet(`ã‚¨ãƒ©ãƒ¼: ã‚·ãƒ¼ãƒˆå†…ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€Œ${userId}ã€ã«å¯¾å¿œã™ã‚‹åå‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
        // åå‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€LINEã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åã‚’ä½¿ã†ãªã©ã®ä»£æ›¿æ¡ˆã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™
        userName = "åå‰ä¸æ˜ã®å‚åŠ è€…"; 
    }
    logToSheet(`ã‚·ãƒ¼ãƒˆã‹ã‚‰åå‰ã€Œ${userName}ã€ã‚’å–å¾—ã—ã¾ã—ãŸã€‚`);
    // --- ã“ã“ã¾ã§ ---

    const messageText = `ã€ã‚¯ãƒªã‚¢é€Ÿå ±ğŸ‰ã€‘\n${userName}ã•ã‚“ãŒã˜ã‚ƒã‚“ã‘ã‚“ã®è¬ã‚’è§£ãã¾ã—ãŸï¼`;
    logToSheet(`ä½œæˆã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${messageText}`);
    
    const userIdsToSend = allData.slice(1) // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é™¤å¤–
                                 .map(row => row[1]) // Båˆ—ã®IDã®ã¿ã‚’æŠ½å‡º
                                 .filter(String); // ç©ºã®ã‚»ãƒ«ã‚’é™¤å¤–
    
    logToSheet(`å–å¾—ã—ãŸé€ä¿¡å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æ•°: ${userIdsToSend.length}ä»¶`);
    logToSheet(`å–å¾—ã—ãŸé€ä¿¡å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒªã‚¹ãƒˆ: ${JSON.stringify(userIdsToSend)}`);

    if (userIdsToSend.length === 0) {
      logToSheet("é€ä¿¡å…ˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒ0ä»¶ã§ã—ãŸã€‚å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™ã€‚");
      return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: 'No users to notify.' }));
    }

    sendPushMessage(userIdsToSend, messageText);
    logToSheet("sendPushMessageé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€å‡¦ç†ã¯æ­£å¸¸ã«çµ‚äº†ã—ã¾ã—ãŸã€‚");

    return ContentService.createTextOutput(JSON.stringify({ status: 'success' }));

  } catch (error) {
    logToSheet(`doPosté–¢æ•°å…¨ä½“ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.toString()}`);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() }));
  }
}

/**
 * æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒªã‚¹ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹
 */
function sendPushMessage(userIds, text) {
  const url = 'https://api.line.me/v2/bot/message/multicast';
  const payload = { to: userIds, messages: [{ type: 'text', text: text }] };
  const options = {
    'method': 'post',
    'contentType': 'application/json',
    'headers': { 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    'payload': JSON.stringify(payload),
    'muteHttpExceptions': true
  };
  
  logToSheet(`LINE APIã«é€ä¿¡ã™ã‚‹ç›´å‰ã®ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(payload)}`);
  const response = UrlFetchApp.fetch(url, options);
  const responseCode = response.getResponseCode();
  const responseBody = response.getContentText();
  
  logToSheet(`LINE APIã‹ã‚‰ã®å¿œç­”ã‚³ãƒ¼ãƒ‰: ${responseCode}`);
  logToSheet(`LINE APIã‹ã‚‰ã®å¿œç­”å†…å®¹: ${responseBody}`);

  if (responseCode < 200 || responseCode >= 300) {
    throw new Error(`Failed to send messages. Response: ${responseBody}`);
  }
}
